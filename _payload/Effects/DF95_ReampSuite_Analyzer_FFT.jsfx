\
// @description DF95_ReampSuite_Analyzer_FFT
// @version 1.0
// @author DF95
// @about
//   Einfache FFT-basierte Anzeige für ReampReturn-Signale.
//   - Zeigt ein grobes 3-Band-Meter (Low/Mid/High) sowie Gesamtlevel.
//   - Output ist Dry-Through, das Plugin ist als Meter gedacht.
//
//   Hinweis:
//   - Dies ist ein minimalistisches JSFX, kein vollständiger RTA.
//
// sliders:
//   0:0<0,1,0.01>Output Gain
//
//----------------------------------------------------------------

desc:DF95 ReampSuite Analyzer FFT

slider1:0<0,1,0.01>Output Gain

@init
  fft_size = 1024;
  fft_block = 1024;
  bufpos = 0;

  low_sum = 0;
  mid_sum = 0;
  high_sum = 0;
  smoothed_low = 0;
  smoothed_mid = 0;
  smoothed_high = 0;

@slider
  out_gain = slider1;

@sample
  spl0 *= out_gain;
  spl1 *= out_gain;

  // simple dry-through meter: nothing fancy per sample
  // (FFT done in @block)

@block
  // basic band energy measurement using FFT
  // this is intentionally minimal.
  n = samplesblock;
  i = 0;
  low_sum = 0;
  mid_sum = 0;
  high_sum = 0;

  // use built-in fft_ifft for a mono sum signal
  // copy block into fft buffer
  fft_size = 1024;
  fft_block = min(n, fft_size);
  i = 0;
  loop(fft_block,
    spl = 0.5*(spl0[i] + spl1[i]);
    buf(i) = spl;
    i += 1;
  );
  // zero rest
  i = fft_block;
  loop(fft_size - fft_block,
    buf(i) = 0;
    i += 1;
  );

  fft(buf, fft_size);

  // simple bins
  bands = fft_size/2;
  low_end = bands*0.15;
  mid_end = bands*0.6;

  i = 1;
  loop(bands-1,
    re = buf(2*i);
    im = buf(2*i+1);
    mag2 = re*re + im*im;
    i <= low_end ? (
      low_sum += mag2;
    ) : i <= mid_end ? (
      mid_sum += mag2;
    ) : (
      high_sum += mag2;
    );
    i += 1;
  );

  // smoothing
  alpha = 0.2;
  smoothed_low = smoothed_low + alpha*(low_sum - smoothed_low);
  smoothed_mid = smoothed_mid + alpha*(mid_sum - smoothed_mid);
  smoothed_high = smoothed_high + alpha*(high_sum - smoothed_high);

@gfx 400 200
  gfx_clear = 0x111111;

  gfx_set(1,1,1);
  gfx_x = 10; gfx_y = 10;
  gfx_drawstr("DF95 ReampSuite Analyzer FFT");

  maxv = max(smoothed_low, max(smoothed_mid, smoothed_high))+1e-12;

  gfx_y = 50;
  gfx_x = 20;
  gfx_drawstr("Low");
  gfx_x = 80;
  gfx_drawstr("Mid");
  gfx_x = 140;
  gfx_drawstr("High");

  gfx_y = 80;
  bar_h = 80;

  // draw bars
  gfx_set(0.5,0.7,1); // low
  h = (smoothed_low/maxv)*bar_h;
  gfx_rect(20, 160-h, 30, h);

  gfx_set(0.5,1,0.5); // mid
  h = (smoothed_mid/maxv)*bar_h;
  gfx_rect(80, 160-h, 30, h);

  gfx_set(1,0.5,0.5); // high
  h = (smoothed_high/maxv)*bar_h;
  gfx_rect(140, 160-h, 30, h);
